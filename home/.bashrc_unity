#  -*- mode: shell-script -*-

[[ "$AWS_ENV" == development* ]] && awsregion us-west-1

[ -d /opt/unity/unitycloud-ops ] && export UNITYCLOUDOPS=/opt/unity/unitycloud-ops

EC2_ROLE="${EC2_ROLE#fullstack-}"

if [ -n "$EC2_ROLE" ]; then
    SECRET_FILE="$(find /var/opt -name "${EC2_ROLE//-jobs}-secret_token.${EC2_ENV}" | xargs -r ls -t | head -1)"
    [ ! -f "$SECRET_FILE" ] && \
        SECRET_FILE="$(ls -1t "/var/opt/unity-${EC2_ROLE}/"*."${EC2_ENV}" 2>/dev/null | head -1)"
    [ -f "$SECRET_FILE" ] && . "$SECRET_FILE" || unset SECRET_FILE
fi

alias reset_dev='rm -rfv devrepos/* db/*.sqlite3; mysql -uroot -e "drop database unity_cloud_collab"; rake db:create db:migrate'
alias mcls='ruby -I /opt/unity/unity-collab-service/current/vendor/bundle/ruby/2.3.0/gems/dalli-2.7.6/lib ~/bin/memcache_list_keys'
alias list_editor_args='find Editor/Src -type f -name "*.cpp" -print0 | xargs -0 grep -F HasARGV'
alias opsme="exec bash -ic 'PATH=\"${PATH}:/opt/unity/unitycloud-ops/bin\" bash'"

if $IAMME && $INTERACTIVE && ihave _z; then
    zf="${_Z_DATA:-${HOME}/.z}"
    touch "$zf"
    shopt -s nullglob # empty list if no match
    for d in /opt/unity/unity*; do
        n="$(basename "$d" | cut -d- -f2-)"
        [ -d "${d}/current" ] && d="${d}/current"
        # only add once to avoid increasing the frecency value
        grep -q "$d" "$zf" || _z --add "$d" 2>/dev/null
    done
    shopt -u nullglob
fi

if $DARWIN; then
    function unity_bin()
    {
        local dn bn
        bn='Contents/MacOS/Unity'
        if [ -x "$bn" ]; then
            echo "bn"
            return 0
        fi
        for dn in '.' build/MacEditor /Applications/Unity*; do
            dn+="/Unity.app"
            if [ -d "$dn" ]; then
                echo "${dn}/${bn}"
                return 0
            fi
        done
        echo "Unable to locate Unity binary" >&2
        return 1
    }

    # if last arg is a path, will open it as a project
    function unity()
    {
        local pdir args=("$@")
        if [[ ${#args[@]} -gt 0 && -d "${args[-1]}" ]]; then
            pdir="${args[-1]}"
            unset args[-1]
            # unity requires full paths
            pdir="$(cd "$pdir" && pwd)"
            # this is how to open more than one unity project
            args+=(-projectpath "$pdir")
        fi
        local ub
        ub="$(unity_bin)"
        echo "${ub} $(shellwords "${args[@]}") >&2"
         tailrun -p "predate $ISO8601_FMT" "${HOME}/Library/Logs/Unity/Editor.log" "${ub}" "${args[@]}"
    }
fi

function health()
{
    local pn="/opt/unity/unity-${EC2_ROLE}-service/current"
    [ ! -d "$pn" ] && pn="/opt/unity/unity-${EC2_ROLE}/current"
    myps unicorn
    ls -ld `readlink "$pn"`
    local h="$(curl -sqf -u "build:${BUILD_SERVICE_SECRET}" localhost:8080/api/health)"
    echo "$h"
    eval `echo "$h" | sed -n 's/.*version":"\([^"]*\).*/local version=\1/p'`
    echo -n "${version}  ->"
    (cd "$pn"; git branch -r --contains "$version"; git log -n1)
}

function whitelist_check()
{
    # TODO: _any_ access token will work, so snag the first one in memcache not expired...
    if [ -z "$ACCESS_TOKEN" -o $# -lt 1 ]; then
        echo 'usage: ACCESS_TOKEN=sekritz whitelist_check <org_fk> [<org_fk>...]' >&2
        return 1
    fi
    local org_fks="$(join , "$@")"
    curl -H "Authorization: Bearer $t" "localhost:5001/v1/alpha-features/api/whitelist/COLLAB/${org_fks}"
    echo
}

function core()
{
    local cargs
    local user_fk='collab'
    if [ "$1" = '-v' ]; then
        shift; cargs='-v'
    else
        cargs='-qsf'
    fi
    if [ "$1" = '-u' ]; then
        shift; user_fk=$1; shift
    fi
    if [ $# -ne 1 ]; then
        echo 'usage core [-v] [-u <user_fk>] <path>'
        return 1
    fi
    curl $cargs -L -u "${user_fk}:${CORE_API_SECRET}" "https://${AWS_ENV_PREFIX}core.cloud.unity3d.com$1"
    local rc=$?
    echo
    return $?
}

function sshrails()
{
    local rhost srvc
    if [ $# -lt 1 ]; then
        echo 'usage: sshrails <remote_host> [<rails_options>...]' >&2
        return 1
    fi

    rhost="$1"; shift

    \ssh -t "$rhost" bash -ic "'
sudo -u nobody -i bash -c \"\
cd /opt/unity/unity-\${EC2_ROLE}-service/current;\
. \$SECRET_FILE;\
export RAILS_ENV=\$EC2_ENV;\
bin/rails "$@"\"'"
}

function volfor()
{
    local pfk="$(downcase "$1")"
    if $IAMME; then
        sudo su -c 'ls -d /mnt/repos/volume*/*/'$pfk
    else
        ls -d /mnt/repos/volume*/*/$pfk
    fi
}

function beanview()
{
    if [ $# -ne 1 ]; then
        echo 'usage: beanstalkd_view <host>' >&2
        return 1
    fi

    local privip
    if [[ $1 = production-* || $1 = staging-* ]]; then
        privip=`grep -A1 -F $1.private ~/.ssh/config | tail -1 | awk '{print $2}'`
    else
        privip=127.0.0.1
    fi

    local port=$(( ((RANDOM<<15)|RANDOM) % 63001 + 2000 ))
    \ssh -L$port:$privip:11300 -o 'ExitOnForwardFailure yes' -nfN $1 || return $?
    local sshpid=`pgrep -f ExitOnForwardFailure`

    BEANSTALK_URL="beanstalk://localhost:$port/" \beanstalkd_view -F
    kill $sshpid
}
complete -F _ssh beanview

function invalidate_cdn()
{
    if [ $# -lt 1 ]; then
        echo 'usage: invalidate_cdn <env> [<env> ...]' >&2
        return 1
    fi

    local objects=()
    while [ $# -gt 0 ]; do
        objects+=('"https://public-cdn.cloud.unity3d.com/config/'$1'"')
        shift
    done

    http -va "public-cloud-api@unity3d.com:${CDN_API_SECRET}" \
         https://api.ccu.akamai.com/ccu/v2/queues/default \
         'action:="invalidate"' 'objects:=['"$(join , "${objects[@]}")"']'
}

if ihave papertrail; then
    alias pt-prod='pt -g "Collab Production"'
fi

# TODO: add helper to cp files
# for h in `host 'production-(jobs-)?collab(-jobs)?-\d+$' | awk '{print $1 ".private"}'`; do ( scp ${h}:/opt/unity/unity-collab-service/current/log/production.log /Users/brad/work/logs/${h}-rails.log & ); done

if [ "$(id -un)" = 'nobody' ]; then
    function collab_exec()
    {
        g collab && ./bin/bundle exec "$@"
    }

    function clone_project()
    {
        git clone "$(volfor $1)" /tmp/$1 && cd /tmp/$1
    }
else
    function collab_exec()
    {
        sudo -u nobody bash -ic "cd '$(p collab)' && ./bin/bundle exec $(shellwords "$@")"
    }

    function clone_project()
    {
        sudo -u nobody git clone "$(volfor $1)" /tmp/$1 && cd /tmp/$1 && sudo chown -R "$(id -un):" .
    }
fi

function collab_rbtrace
{
    collab_exec rbtrace --ps 'unicorn worker' -e "$@"
}

function collab_loglevel()
{
    collab_rbtrace "Rails.logger.level = :$1"
}

function convert_pointers()
{
    local download=false
    if [ "$1" = '--download' ]; then
        download=true; shift
    fi

    local max_failures=10
    if [ "$1" = '--max-failures' ]; then
        shift; max_failures=$1; shift
    fi

    if [ $# -ne 1 ]; then
        echo 'usage: convert_pointers [--download] [--max-failures <count>] <directory>' >&2
        return 1
    fi

    # convert dev-user to be dev/user for bucket
    local bucket="unitycloud-collab-store-${AWS_ENV/-${USER}//${USER}}"
    local dir="$(cd "$1" && pwd -P)"
    local pfk="$(basename "$dir")"
    local failures=0

    local total=`git ls-files "$dir" | wc -l`
    local count=0
    git ls-files | while read fn; do
        (( count++ ))
        md5="$(awk '/^uc_md5/{print $2}' "$fn")"
        if [ -z "$md5" ]; then
            echo "No MD5 found in ${fn}" >&2
            (( failures++ ))
        elif $download; then
            mv -v "$fn" "${fn}.pointer"
            key="${bucket}/${pfk}/${md5}"
            if ! aws s3 cp "s3://$key" "$fn"; then
                mv -v "${fn}.pointer" "$fn"
                (( failures++ ))
            fi
        else
            key="${pfk}/${md5}"
            if ! aws s3api head-object --bucket "$bucket" --key "$key" >/dev/null 2>&1; then
                echo "Missing ${bucket}/${key} in ${fn}" >&2
                key="collab_archive_${pfk}/${md5}"
                if ! aws s3api head-object --bucket "$bucket" --key "$key" >/dev/null 2>&1; then
                    echo "Also missing ${bucket}/${key} in ${fn}" >&2
                    (( failures++ ))
                fi
            fi
        fi
        if [ $failures -ge $max_failures ]; then
            echo "Giving up after ${failures} failures" >&2
            break
        fi
        [ $(( $count % 10 )) -eq 0 ] && echo "Processed ${count} / ${total}"
    done
}

function unconvert_pointers()
{
    if [ $# -ne 1 ]; then
        echo 'usage: convert_pointers <directory>' >&2
        return 1
    fi

    find "$1" -name .git -prune -o -type f -name '*.pointer' -print | while read fn; do
        dir="$(dirname "$fn")"
        orig="${dir}/$(basename "$fn" .pointer)"
        mv -vf "$fn" "$orig"
    done
}

# moves all files found in transaction folders out into the project root
function convert_transactions()
{
    if [ $# -lt 1 ]; then
        echo 'usage: convert_transactions <project_id> [<project_id>...]' >&2
        return 1
    fi

    echo 'TODO: make converter for old transaction folders in s3!'
}

function simplified_s3_log()
{
    if [ $# -lt 1 ]; then
        echo 'usage: simplified_s3_log <log> [<log>...]' >&2
        return 1
    fi
    # TODO: figure out a way to get user agent string between quotes...
    cat "$@" | \
        awk '$9 ~ /\//{gsub("/"," ",$9); split($8,a,"."); print $3 $4 " " $5 " " a[2] " " $9 " " $13}'
}

function split_s3_key_from_log()
{
    if [ $# -lt 1 ]; then
        echo 'usage: split_s3_key_from_log <log> [<log>...]' >&2
        return 1
    fi
    cat "$@" | awk '$9 ~ /\//{gsub("/"," ",$9);a[$9]++} END{for (n in a) print n}'
}

function get_project_ids_from_s3_log()
{
    if [ $# -lt 1 ]; then
        echo 'usage: get_project_ids_from_s3_logs <log> [<log>...]' >&2
        return 1
    fi
    split_s3_key_from_log "$@" | awk '{print $1}' | sort | uniq -c | sort -n
}

function report_project_versions()
{
    local lfn
    [ -f "$1" ] && lfn="$1" || lfn='-'

    if test $# -eq 0 && istty stdin; then
        echo 'usage: report_project_versions [<access_log_file>]' >&2
        return 1
    fi

    cat "$lfn" | while read line; do
        res="$(echo "$line" | sed -n 's/^.*projects\/\([^\/]*\).*UnityEditor\/\([^ ]*\).*/upid="\1";ver="\2"/p')"
        eval "$res"
        if [ -z "$upid" -o -z "$ver" ]; then
            continue
        fi
        tag="$(hg_user_agent_revision -tag "$ver")"
        rc=$?
        if [ -z "$tag" -o $rc -ne 0 ]; then
            echo "Failed to get tag for ${ver}" >&2
        else
            echo "${upid}:${tag}:${ver}"
        fi
    done
}

function statsd_report()
{
    local host='internal-stats.cloud.unity3d.com'
    if [ "$1" = '-h' ]; then
        shift; host="$1"; shift
    fi
    # https://github.com/b/statsd_spec | https://github.com/etsy/statsd/blob/master/docs/metric_types.md
    declare -A cmds
    cmds=([count]=c [gauge]=g [time]=ms [hist]=h [meter]=m [set]=s)
    local cmd=${cmds[$1]}
    local keys
    if [ $# -lt 2 -o -z "$cmd" ]; then
        keys="$(join '|' `echo "${!cmds[@]}"`)"
        echo "usage: stats_report [-h <host>] {${keys}} <metric> [<value>] [<sample_rate>]" >&2
        return 1
    fi
    local msg="${HOSTNAME//./_}.${2}:${3:-1}|${cmd}"
    [ -n "$4" ] && msg+="|@$4"
    echo "$msg"
    echo "$msg" | nc -uw0 "$host" 8125
}

function beanstool()
{
    local beanbin="${HOME}/bin/beanstool"
    if [ ! -x "$beanbin" ]; then
        (
            set -e
            cd "${HOME}/bin"
            wget https://github.com/src-d/beanstool/releases/download/v0.2.0/beanstool_v0.2.0_linux_amd64.tar.gz
            tar zxf beanstool_v0.2.0_linux_amd64.tar.gz --strip-components=1 beanstool_v0.2.0_linux_amd64/beanstool
            rm -f beanstool_v0.2.0_linux_amd64.tar.gz
        )
    fi
    "$beanbin" "$@" --host="${BEANSTOOL_IP:=$(get_iface_ip inet eth0)}:11300"
}

# TODO add send_syslog() to enable posting to papertrail (should be done in our deploy script, too)

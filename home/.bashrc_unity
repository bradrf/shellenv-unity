#  -*- mode: shell-script -*-

[ -d /opt/unity/unitycloud-ops ] && export UNITYCLOUDOPS=/opt/unity/unitycloud-ops

shopt -s nullglob # empty list if no match
s=`echo /var/opt/unity*/*secret_token*`
[ -f "$s" ] && . "$s"
shopt -u nullglob

alias reset_dev='rm -rf devrepos/ db/*.sqlite3; rake db:migrate'

if $IAMME && $INTERACTIVE && ihave s; then
    shopt -s nullglob # empty list if no match
    # FIXME: this assignes unity-collab-ui to be collab (fix to know -service or -ui)
    for d in /opt/unity/unity*; do
        n=`basename "$d" | cut -d- -f2`
        t=`basename "$d" | cut -d- -f3`
        [ "$t" = 'service' ] || n="${n}${t}"
        test -f "$SDIRS" && grep -q "$n" "$SDIRS" && continue
        [ -d "${d}/current" ] && d="${d}/current"
        (cd "$d" && s "$n")
    done
    shopt -u nullglob
    [ -f "$SDIRS" ] && chmod 644 "$SDIRS" # allow nobody and others to read bashmark entries
fi

function health()
{(
    set -x
    readlink /opt/unity/unity-collab-service/current
    curl -qfs http://localhost/api/health | prettyjson
    curl -qsf http://localhost/api/disk | prettyjson
)}

function sshrails()
{
    local rhost srvc
    if [ $# -lt 1 ]; then
        echo 'usage: sshrails <remote_host> [<rails_options>...]' >&2
        return 1
    fi

    rhost="$1"; shift

    ssh -t "$rhost" bash -c ':;\
eval `ec2tags`
r=`echo $role | sed "s/fullstack-//"`
t=`find /var/opt -name $r-secret_token.$env | head -1`
set -x
sudo -u nobody -i bash -c "\
cd /opt/unity/unity-$r-service/current;\
. $t;\
export RAILS_ENV=$env;\
bin/rails '"$@"'"'
}

#!/bin/bash

# REQUIREMENTS: bash v4, python v2.7

VERSION='0.1.0'
VERBOSE=false
HEADERS=()
PRETTY=false
EVAL=false
FOLLOW=false
SAVE=''

while true; do
    case "$1" in
        -v) VERBOSE=true;;
        -H) shift; HEADERS+=("$1");;
        -host) shift; HOST_OVERRIDE=$1;;
        -pretty) PRETTY=true;;
        -eval) EVAL=true;;
        -follow) FOLLOW=true;;
        -save) shift; SAVE=$1;;
        *) break;;
    esac
    shift
done

if $PRETTY && $EVAL; then
    echo 'Can not use both -pretty and -eval for output' >&2
    exit 2
fi

BN="$(basename "$0" .sh)"
if [[ $# -lt 3 ]]; then
    cat <<EOF >&2

usage: ${BN} [<options>] <env> <method> <url> [<body> | <file>]

  ${BN} (v${VERSION}) is a tool to automatically handle authentication and URL selection when working with Unity HTTP APIs

  OPTIONS:
    -v           enable verbose output (show HTTP headers, etc.)
    -H           add a custom header (can be used multiple times)
    -host <val>  host header value (otherwise uses host from <url>; can be a variable name)
    -follow      follow 302 redirects using the indicated Location header
    -pretty      write JSON nicely formatted (does not work w/ -eval)
    -eval        write JSON response as evaluable shell key/value pairs (does not work w/ -pretty)
    -save <file> write response to <file>

  ENV:       l[ocal] | d[ev] | s[taging] | p[roduction]

  METHOD:    g[et] | po[st] | pu[t] | d[elete]

  URL:       provide a full URL -- may contain keys from the <env> config retrieved
             (use a value of "config" to dump the set of key/values available in <env>)

  BODY:      provide the value sent using curl's data-binary option (assumes JSON format)
  FILE:      provide a filename to read and send using curl's data-binary option (detects content type)

  EXAMPLES:

    list all of your orgs in the "dev" cloud environment:
      # ucurl dev get \\\${GENESIS_API_URL}/v1/core/api/orgs

    list all unarchived projects in the "bradandy" org:
      # ucurl dev get \\\${GENESIS_API_URL}/v1/core/api/orgs/bradandy/projects | \\
          awk -F\\" '/"name"/{n=\$4};/guid/{g=\$4};/archived.*false/{print g,n}'

    archive a project:
      # ucurl dev delete \\\${GENESIS_API_URL}/v1/core/api/orgs/bradandy/projects/95015c7a-b24b-4301-b2ae-844502f1cb7c

    unarchive a project:
      # ucurl dev put \\\${GENESIS_API_URL}/v1/core/api/orgs/bradandy/projects/95015c7a-b24b-4301-b2ae-844502f1cb7c/unarchive

    get the most recent revision from a project hosted in Collab:
      # ucurl -pretty dev get \\\${COLLAB}/api/projects/6086dd15-f6c1-4c7e-8411-34cc5183008b/branches/master/revisions\\?limit=1

    get a list of all file entries for a Collab project:
      # ucurl -pretty dev get \\\${COLLAB}/api/projects/6086dd15-f6c1-4c7e-8411-34cc5183008b/branches/master/revisions/HEAD/entries\?recurse

    get a signed URL from Collab for an MD5 file for uploading:
      # ucurl dev post \\\${COLLAB}/api/projects/6086dd15-f6c1-4c7e-8411-34cc5183008b/uploads '{"files":["2c087aca87fe65bb31d6e15835965712"]}'

    display detail health from Collab service:
      # ucurl -pretty dev get \\\${COLLAB}/api/health\?include=memory,raindrops

    force use of alternate region:
      # ucurl -v -host \\\$COLLAB prod get https://kong-prod-euc1-public.cloud.unity3d.com/api/health

EOF
    exit 1
fi

case "$1" in
    l*) CLOUD_ENV=local;;
    d*) CLOUD_ENV=dev;;
    s*) CLOUD_ENV=staging;;
    p*) CLOUD_ENV=production;;
    *)
        echo "Unknown environment: $1" >&2
        exit 3
esac
shift

case "$1" in
    g*)  METHOD=GET;;
    po*) METHOD=POST;;
    pu*) METHOD=PUT;;
    d*)  METHOD=DELETE;;
    *)
        echo "Unknown method: $1" >&2
        exit 4
esac
shift

URL="$1"; shift

if [[ $# -gt 0 ]]; then
    if [[ -f "$1" ]]; then
        BODY="@$1"
        BODY_SIZE="$(python -c "import os; print os.stat('$1').st_size")"
        [[ "${HEADERS[@]}" =~ 'Content-Type:' ]] || HEADERS+=("Content-Type: $(file -b --mime-type "$1")")
    else
        BODY="$1"
        BODY_SIZE=${#BODY}
    fi
    shift
else
    BODY_SIZE=0
fi

umask 0077 # protect files like the user credentials cache to be accessible only by current user

######################################################################

function simple_curl() {
    unset CODE LOCATION RESPONSE

    local expect
    if [[ "$1" = '-expect' ]]; then
        shift; expect=$1; shift
    fi

    local save
    if [[ "$1" = '-save' ]]; then
        shift; save=$1; shift
    fi

    local method=$1; shift
    local url=$1; shift
    local body=$1; shift

    local headers=("$@")
    [[ "${headers[@]}" =~ 'Content-Type:' ]] || headers+=('Content-Type: application/json')

    local hfn="$(mktemp /tmp/${BN}hfn.XXX)"
    local rfn
    if [[ -n "$save" ]]; then
        rfn=$save
    else
        rfn="$(mktemp /tmp/${BN}rsp.XXX)"
    fi

    local cargs=(-A "${BN}/${VERSION}" -D "${hfn}" -o "${rfn}")
    $VERBOSE && cargs+=(-v)
    cargs+=(-X "$method")
    for hdr in "${headers[@]}"; do cargs+=(-H "$hdr"); done

    [[ -n "$body" ]] && cargs+=(--data-binary "$body")
    [[ $BODY_SIZE -lt 10485760 ]] && cargs+=(-s) # keep silent for small uploads

    if $VERBOSE; then
        curl "${cargs[@]}" "$url" 2> >(sed 's/Bearer .*$/Bearer [REDACTED]/' >&2)
    else
        curl "${cargs[@]}" "$url"
    fi
    local res=$?

    eval "$(awk 'NR==1{sub("\r","",$2);print "CODE="$2};/^Location:/{sub("\r","",$2);print "LOCATION=\""$2"\""}' "$hfn")"
    rm -f "$hfn"

    if [[ -z "$save" ]]; then
        RESPONSE="$(cat "$rfn")"
        rm -f "$rfn"
    fi

    [[ -n "$expect" ]] || expect=$CODE
    if [[ $res -ne 0 ]] || [[ $CODE -ne $expect ]]; then
        $VERBOSE && echo "FAILED:      curl$(printf ' %q' "${cargs[@]}") '$url'" >&2
        cat <<EOF >&2
CURL STATUS: ${res}
HTTP CODE:   ${CODE}
HTTP BODY:   ${RESPONSE}
EOF
        exit 5
    fi
}

function response_to_key_values() {
    echo "$RESPONSE" | \
python -c 'import sys,json,re; \
print ";".join("%s=\"%s\"" % (re.sub(r"[\W_]+","_",k.upper()),v) for (k,v) in json.load(sys.stdin).items())'
}

function eval_response() {
    eval "$(response_to_key_values)"
}

function get_access_token() {
    local now body
    local cache_fn="${HOME}/.${BN}_${CLOUD_ENV}_cache"

    if [[ -f "$cache_fn" ]]; then
        . "$cache_fn"
        now=$(date +%s)
        if [[ $EXPIRES_AT -le $now ]]; then
            echo "Access token is expired." >&2
            unset ACCESS_TOKEN
        fi
    fi

    if [[ -z "$ACCESS_TOKEN" ]]; then
        if [[ -n "$REFRESH_TOKEN" ]]; then
            body='{"grant_type":"refresh_token","refresh_token":"'"${REFRESH_TOKEN}"'"}'
        else
            read -p 'email? ' email
            read -sp ' pass? ' pass
            echo
            body='{"grant_type":"password","username":"'"${email}"'","password":"'"${pass}"'"}'
        fi

        simple_curl -expect 200 POST "${GENESIS_API_URL}/v1/core/api/login" "$body"
        $VERBOSE && echo "$RESPONSE" >&2
        eval_response

        EXPIRES_AT=$(( $(date +%s) + $EXPIRES_IN - 30 ))
        echo "ACCESS_TOKEN='${ACCESS_TOKEN}';REFRESH_TOKEN='${REFRESH_TOKEN}';EXPIRES_AT='${EXPIRES_AT}';" > "$cache_fn"
        echo "Access token expires in ${EXPIRES_IN} seconds" >&2
    fi
}

######################################################################

cloudrc="${HOME}/.cloud${CLOUD_ENV}rc"
if [[ -r "$cloudrc" ]]; then
    RESPONSE="$(cat "$cloudrc")"
    CODE=200
else
    simple_curl GET "https://public-cdn.cloud.unity3d.com/config/${CLOUD_ENV}"
    echo "$RESPONSE" > "$cloudrc"
fi

if [[ "$URL" = 'config' ]]; then
    PRETTY=true
else
    eval_response           # loads config keys as interpolation variables

    if [[ -n "$HOST_OVERRIDE" ]]; then
        final_host="$(eval echo \"${HOST_OVERRIDE}\" | awk -F/ '{print $3}')" # strip out host if a URI
        HEADERS+=("Host: ${final_host}")
    fi

    # login and interpolate the URL
    get_access_token
    eval "final_url=\"$URL\""

    if [[ ! "${HEADERS[@]}" =~ 'Authorization:' ]]; then
        HEADERS+=("Authorization: Bearer ${ACCESS_TOKEN}")
    fi

    if [[ -n "$SAVE" ]]; then
        simple_curl -save "$SAVE" "$METHOD" "$final_url" "$BODY" "${HEADERS[@]}"
    else
        simple_curl "$METHOD" "$final_url" "$BODY" "${HEADERS[@]}"
    fi
fi

if [[ -n "$SAVE" ]]; then
    echo "Saved to $SAVE" >&2
elif [[ -z "$RESPONSE" ]]; then
    echo "No body received. HTTP status code: ${CODE}" >&2
elif $PRETTY; then
    echo "$RESPONSE" | python -mjson.tool
elif $EVAL; then
    response_to_key_values
else
    echo "$RESPONSE"
fi

lvl=$(( $CODE / 100 ))
[[ $lvl -eq 2 ]] && exit

if $FOLLOW && [[ $CODE -eq 302 ]] && [[ -n "$LOCATION" ]]; then
    echo "Following 302 to ${LOCATION}" >&2
    cargs=(-L)
    $VERBOSE && cargs+=(-v)
    [[ -n "$SAVE" ]] && cargs+=(-o "$SAVE")
    exec curl "${cargs[@]}" "$LOCATION"
fi

[[ -n "$RESPONSE" ]] && echo "HTTP status code: ${CODE}" >&2
exit $(( $lvl * 10 ))
